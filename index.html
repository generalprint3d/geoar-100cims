<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>GeoAR Multimapa - OSM</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
html, body {
  margin: 0;
  padding: 0;
  overflow: hidden;
  background: black;
}

/* üì∑ c√†mera */
#camera {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  z-index: 1;
}

/* üó∫Ô∏è mapa */
#map {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 2;
  background: transparent;
}

/* üéöÔ∏è controls */
#controls {
  position: fixed;
  bottom: 20px;
  left: 20px;
  right: 20px;
  z-index: 999;
  background: rgba(0,0,0,0.5);
  padding: 10px;
  border-radius: 10px;
  color: white;
  font-family: sans-serif;
}

#mapSelector {
  margin-bottom: 10px;
  width: 100%;
}
</style>
</head>

<body>

<video id="camera" autoplay playsinline muted></video>
<div id="map"></div>

<div id="controls">
  Selecciona mapa:
  <select id="mapSelector">
    <option value="DATA/01_Bastiments_2km.kml">01_Bastiments_2km</option> <!-- Nom al selector: "Bastiments 2km" -->
    <option value="DATA/01_Bellmunt_2500m.kml">01_Bellmunt_2500m</option> <!-- Nom al selector: "Bellmunt 2500m" -->
    <option value="DATA/01_Besiberri-Nord_2500m.kml">01_Besiberri-Nord_2500m</option> <!-- Nom al selector: "Besiberri Nord 2500m" -->
    <option value="DATA/01_Cabrera_2500m.kml">01_Cabrera_2500m</option> <!-- Nom al selector: "Cabrera 2500m" -->
    <option value="DATA/01_CapBoumort_4000m.kml">01_CapBoumort_4000m</option> <!-- Nom al selector: "Cap Boumort 4000m" -->
    <option value="DATA/01_CapUrdet_4000m.kml">01_CapUrdet_4000m</option> <!-- Nom al selector: "Cap Urdet 4000m" -->
    <option value="DATA/01_Cap_Gallina_Pelada-2500.kml">01_Cap_Gallina_Pelada-2500</option> <!-- Nom al selector: "Cap Gallina Pelada 2500" -->
    <option value="DATA/01_Caro_2500m.kml">01_Caro_2500m</option> <!-- Nom al selector: "Caro 2500m" -->
    <option value="DATA/01_Cogullo-dEstela_1250m.kml">01_Cogullo-dEstela_1250m</option> <!-- Nom al selector: "Cogullo d'Estela 1250m" -->
    <option value="DATA/01_Comanegra_2500.kml">01_Comanegra_2500</option> <!-- Nom al selector: "Comanegra 2500" -->
    <option value="DATA/01_ElBalandrau_3000m-radi.kml">01_ElBalandrau_3000m-radi</option> <!-- Nom al selector: "El Balandrau 3000m radi" -->
    <option value="DATA/01_ElFarell_4000m.kml">01_ElFarell_4000m</option> <!-- Nom al selector: "El Farell 4000m" -->
    <option value="DATA/01_ElMont_2500.kml">01_ElMont_2500</option> <!-- Nom al selector: "El Mont 2500" -->
    <option value="DATA/01_ElNegrell_5000m.kml">01_ElNegrell_5000m</option> <!-- Nom al selector: "El Negrell 5000m" -->
    <option value="DATA/01_ElPedro_4000m.kml">01_ElPedro_4000m</option> <!-- Nom al selector: "El Pedro 4000m" -->
    <option value="DATA/01_ElsEncantats-1km.kml">01_ElsEncantats-1km</option> <!-- Nom al selector: "Els Encantats 1km" -->
    <option value="DATA/01_ElTaga_4175.kml">01_ElTaga_4175</option> <!-- Nom al selector: "El Taga 4175" -->
    <option value="DATA/01_Envolupant_14x14km_CapDeCreus.kml">01_Envolupant_14x14km_CapDeCreus</option> <!-- Nom al selector: "Cap de Creus 14x14km" -->
    <option value="DATA/01_LoCoscollet_4000m.kml">01_LoCoscollet_4000m</option> <!-- Nom al selector: "Lo Coscollet 4000m" -->
    <option value="DATA/01_MolaLord_2500m.kml">01_MolaLord_2500m</option> <!-- Nom al selector: "Mola Lord 2500m" -->
    <option value="DATA/01_OllaDeNuria_4164m.kml">01_OllaDeNuria_4164m</option> <!-- Nom al selector: "Olla de N√∫ria 4164m" -->
    <option value="DATA/01_Pedraforca_2km.kml">01_Pedraforca_2km</option> <!-- Nom al selector: "Pedraforca 2km" -->
    <option value="DATA/01_PuigBassegoda-2088m.kml">01_PuigBassegoda-2088m</option> <!-- Nom al selector: "Puig Bassegoda 2088m" -->
    <option value="DATA/01_TucMolieres-6000m.kml">01_TucMolieres-6000m</option> <!-- Nom al selector: "Tuc Molieres 6000m" -->
  </select>
  <br><br>
  Transpar√®ncia mapa base:
  <input type="range" id="opacity" min="0" max="1" step="0.05" value="0.7">
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-omnivore/leaflet-omnivore.min.js"></script>

<script>
// =======================
// üì∑ activar c√†mera
// =======================
navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
.then(stream => {
  document.getElementById("camera").srcObject = stream;
})
.catch(err => {
  alert("Error c√†mera: " + err);
});

// =======================
// üó∫Ô∏è mapa base
// =======================
var map = L.map('map', { zoomControl:true, attributionControl:false, inertia:true, inertiaDeceleration:3000, inertiaMaxSpeed:1500 }).setView([42.13,1.78],13);

var osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,opacity:0.7}).addTo(map);

// =======================
// üéØ Funci√≥ per carregar KML amb estil i zoom correcte
// =======================
let currentKMLLayer = null;

function loadKML(kmlFile){
  if(currentKMLLayer){ map.removeLayer(currentKMLLayer); currentKMLLayer = null; }

  omnivore.kml(kmlFile)
  .on('ready', function(){
    currentKMLLayer = this;

    currentKMLLayer.eachLayer(function(layer){
      if(layer.setStyle){
        layer.setStyle({
          fill:false,
          fillOpacity:0,
          color:"#FFAA00",
          weight:3,
          opacity:0.8
        });
      }
    });

    map.addLayer(currentKMLLayer);

    const bounds = currentKMLLayer.getBounds();
    if(bounds.isValid()){
      map.fitBounds(bounds);
      map.setZoom(Math.min(map.getZoom(),17));
    }
  })
  .on('error', function(e){ console.error("Error carregant KML",e); });
}

// =======================
// üéöÔ∏è Slider transpar√®ncia
// =======================
document.getElementById("opacity").addEventListener("input", function(e){ osmLayer.setOpacity(e.target.value); });

// =======================
// üîÄ Selector de mapa
// =======================
const mapSelector = document.getElementById("mapSelector");
mapSelector.addEventListener("change", function(){ loadKML(mapSelector.value); });

// =======================
// üîó Funci√≥ per llegir par√†metre URL
// =======================
function getURLParameter(name){ return new URLSearchParams(window.location.search).get(name); }

// =======================
// Carregar KML inicial (par√†metre URL si existeix)
const kmlParam = getURLParameter("kml");
if(kmlParam){
  const opt = Array.from(mapSelector.options).find(o => o.value === kmlParam);
  if(opt){ mapSelector.value = opt.value; loadKML(opt.value); }
  else loadKML(mapSelector.value);
} else loadKML(mapSelector.value);
</script>

</body>
</html>